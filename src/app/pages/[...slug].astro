---
import Layout from '@/app/layouts/Layout.astro';
import DocContent from '@/features/docs/components/DocContent';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const manifestPath = path.join(process.cwd(), 'public/data/docs/manifest.json');
  
  if (!fs.existsSync(manifestPath)) {
    console.warn('manifest.json not found, returning empty paths');
    return [];
  }
  
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  
  return manifest.map((doc: any) => {
    const docPath = path.join(process.cwd(), `public/data/docs/${doc.slug}.json`);
    
    if (!fs.existsSync(docPath)) {
      console.warn(`Missing doc file: ${docPath}`);
      return null;
    }
    
    const fullDoc = JSON.parse(fs.readFileSync(docPath, 'utf-8'));
    
    // Генерируем путь в зависимости от наличия type
    let pathSegments: string[];
    if (doc.type && doc.type.trim() !== '') {
      pathSegments = [doc.type, doc.slug];
    } else {
      pathSegments = [doc.slug];
    }
    
    return {
      params: { slug: pathSegments },
      props: { doc: fullDoc },
    };
  }).filter(Boolean);
}

const { slug } = Astro.params;
const { doc } = Astro.props as { doc: any };

if (!doc || !slug) {
  return Astro.redirect('/404');
}
---

<Layout
  title={doc.title}
  description={doc.description}
  image={doc.image}
  url={`/${slug.join('/')}`}
  type="article"
  author={doc.author}
  date={doc.date}
  keywords={doc.keywords}
  robots={doc.robots}
>
  <DocContent client:only="react" doc={doc} />
</Layout>
